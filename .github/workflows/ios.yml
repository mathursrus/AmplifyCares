name: Manual iOS Build for Cordova App

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: 'Build Type (Debug/Release)'
        required: true
        default: 'Debug'

jobs:
  build_ios:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '14' # Specify according to your project's need

    - name: Install Cordova
      run: npm install -g cordova
      
    - name: Install Project Dependencies
      run: npm install
      
    - name: Add iOS Platform
      run: npx cordova platform add ios
      working-directory: ./cordova

    - name: Download Provisioning Profile
      run: |
           mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles && 
           cp cordova/SelfCareMattersTest.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
           
    - name: Build iOS App
      run: npx cordova build ios --${{ github.event.inputs.buildType }} --device --buildFlag="-UseModernBuildSystem=0" --provisioningProfile="$HOME/Library/MobileDevice/Provisioning Profiles/SelfCareMattersTest.mobileprovision"
      working-directory: ./cordova

    - name: Install Fastlane
      run: gem install fastlane -NV
      
    - name: Deploy to TestFlight
      run: fastlane deploy_to_testflight
      env:
        FASTLANE_APPLE_ID: ${{ secrets.APPLE_DEVELOPER_USERNAME }} # Apple Developer Account Username
        FASTLANE_API_KEY: ${{ secrets.APPLE_API_KEY }} # Path to .p8 file
        FASTLANE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }} # Apple Team ID

    - name: Archive Production Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: ios-app
        path: ./cordova/platforms/ios/build/device/**/*.ipa
